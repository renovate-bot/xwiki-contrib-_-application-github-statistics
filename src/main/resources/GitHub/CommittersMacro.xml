<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>GitHubStats</web>
  <name>CommittersMacro</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>GitHubStats.WebHome</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1342613311000</creationDate>
  <date>1342617050000</date>
  <contentUpdateDate>1342617050000</contentUpdateDate>
  <version>1.1</version>
  <title>Committers Macro</title>
  <template/>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <object>
    <class>
      <name>XWiki.WikiMacroClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>9</number>
        <prettyName>Macro code</prettyName>
        <rows>20</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentDescription>
        <disabled>0</disabled>
        <name>contentDescription</name>
        <number>8</number>
        <prettyName>Content description (Not applicable for "No content" type)</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </contentDescription>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>7</number>
        <prettyName>Macro content type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator>|</separator>
        <separators>|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>Optional|Mandatory|No content</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <defaultCategory>
        <disabled>0</disabled>
        <name>defaultCategory</name>
        <number>4</number>
        <prettyName>Default category</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultCategory>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>3</number>
        <prettyName>Macro description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <id>
        <disabled>0</disabled>
        <name>id</name>
        <number>1</number>
        <prettyName>Macro id</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </id>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>2</number>
        <prettyName>Macro name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <supportsInlineMode>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>supportsInlineMode</name>
        <number>5</number>
        <prettyName>Supports inline mode</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </supportsInlineMode>
      <visibility>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>visibility</name>
        <number>6</number>
        <prettyName>Macro visibility</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator>|</separator>
        <separators>|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>Current User|Current Wiki|Global</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </visibility>
    </class>
    <name>GitHubStats.CommittersMacro</name>
    <number>0</number>
    <className>XWiki.WikiMacroClass</className>
    <guid>2aff74db-93bd-4b52-ae42-4c7e90ac3ffb</guid>
    <property>
      <code>{{groovy}}
import org.apache.commons.io.*
import org.eclipse.jgit.api.*
import org.eclipse.jgit.lib.*
import org.eclipse.jgit.revwalk.*
import org.eclipse.jgit.storage.file.*
import org.gitective.core.*
import org.gitective.core.filter.commit.*
import groovy.json.*
import org.gitective.core.stat.*

def service = services.get("git") 

// Get the list of repositories to display data for
def repos = []
def repoNames = []
if (xcontext.macro.params.repositories != null) {
  xcontext.macro.params.repositories.tokenize(",").each() { repoName -&gt;
    // Find the Git URL for that repo
    def repoData = services.query.xwql("select distinct repo.giturl from Document doc, doc.object(GitHubStats.RepositoryClass) as repo where repo.organization = '${xcontext.macro.params.organization}' and repo.name = '${repoName}'").execute()
    if (repoData.size() == 1) {
      def repo = service.getRepository(repoData[0], repoName)
      repos.add(repo)
      repoNames.add(repoName)
    } else {
      println "{{error}}No GitHub Repository defined in this wiki for the '${it}' repository name. You need to [[Import&gt;&gt;GitHubStats.ImportRepositories]] this repository first.{{/error}}"
      return
    }
  }
} else {
  // Get all repositories for the xwiki organization
  def repoData = services.query.xwql("select distinct repo.giturl, repo.name from Document doc, doc.object(GitHubStats.RepositoryClass) as repo where doc.object(GitHubStats.RepositoryClass).organization = '${xcontext.macro.params.organization}'").execute()
  repoData.each() {
    // For each repo, clone it locally to get stats for it
    def repo = service.getRepository(it[0], it[1])
    repos.add(repo)
    repoNames.add(it[1])
  }

  if (repos.size() == 0) {
    println "{{error}}There are no GitHub Repositories defined in this wiki for the '${xcontext.macro.params.organization}' organization. You need to [[Import&gt;&gt;GitHubStats.ImportRepositories]] some repositories for this organization first.{{/error}}"
    return
  }
}

def finder = new CommitFinder(repos)
def countFilter = new CommitCountFilter()
def histogramFilter = new CommitterHistogramFilter()
def committerFilter = new CommitterSetFilter()
def filters = new AndCommitFilter()
filters.add(countFilter, committerFilter, histogramFilter)

def sinceDays = xcontext.macro.params.since.toInteger()
if (sinceDays &gt; 0) {
  def dateFilter = new CommitterDateFilter(new Date() - sinceDays)
  finder.setFilter(dateFilter)
}

finder.setMatcher(filters)
finder.find()

// Get all committers in the wiki for the defined repos, find all their aliases and save them so that we can later associate aliases with GitHub ids
def committerAliases = [:]
def committerAvatars = [:]
def committerNames = [:]
def memberOfClause = repoNames.collect { "'${it}' member of committer.repositories" }.join(" or ")
services.query.xwql("from doc.object(GitHubStats.CommitterClass) as committer where (${memberOfClause})").execute().each() { docName -&gt;
    def committerDoc = xwiki.getDocument(docName)
    def committerObject = committerDoc.getObject("GitHubStats.CommitterClass")
    def avatar = committerObject.getProperty("avatar").value
    def id = committerObject.getProperty("id").value
    def aliases = committerObject.getProperty("aliases").value
    def name = committerObject.getProperty("name").value
    // Get all aliases
    aliases.each() { alias -&gt;
      committerAliases.put(alias, id)
    }
    committerAliases.put(name, id)
    committerAliases.put(id, id)
    committerAvatars.put(id, avatar)
    committerNames.put(id, name)
}

def listContributors = xcontext.macro.params.contributors == "true"

def stats = [:]
histogramFilter.getHistogram().getUserActivity(new CommitCountComparator()).each() {
  if (committerAliases.get(it.name) != null || listContributors) {
    def computedName = committerAliases.get(it.name) ?: it.name
    def total = stats.get(computedName) ?: 0
    total = total + it.count
    stats.put(computedName, total)
  }
}

print "|=Avatar|=User Id|=# Commits"
println listContributors ? "|=Committer?" : ""

stats.each() { userid, count -&gt;
  def avatar = committerAvatars.get(userid)
  def name = committerNames.get(userid) ?: userid
  def isCommitter = committerNames.get(userid) == null ? "(x)" : "(/)"
  if (avatar != null) {
    print "|[[image:${avatar}]]|${name}|(% style='background-color: #D1F0E0' %)${count}"
  } else {
    print "||${name}|(% style='background-color: #D1F0E0' %)${count}"
  }
  println listContributors ? "|${isCommitter}" : ""
}

// Add all committers who've not already been listed
if (xcontext.macro.params.inactives == "true") {
  committerNames.each() { userid, name -&gt;
    if (stats.get(userid) == null) {
      def avatar = committerAvatars.get(userid)
      print "|[[image:${avatar}]]|${name}|(% style='background-color: #F0D1D6' %)0"
      println listContributors ? "|(/)" : ""
    }
  }
}
{{/groovy}}</code>
    </property>
    <property>
      <contentDescription/>
    </property>
    <property>
      <contentType>No content</contentType>
    </property>
    <property>
      <defaultCategory>content</defaultCategory>
    </property>
    <property>
      <description>List committers and their activity in a table</description>
    </property>
    <property>
      <id>committers</id>
    </property>
    <property>
      <name>Committers</name>
    </property>
    <property>
      <supportsInlineMode>0</supportsInlineMode>
    </property>
    <property>
      <visibility>Current Wiki</visibility>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
    </class>
    <name>GitHubStats.CommittersMacro</name>
    <number>0</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>fd5e191f-08a6-47b0-a87a-f2584bb4eecd</guid>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>List committers only for the specified GitHub organization</description>
    </property>
    <property>
      <mandatory>1</mandatory>
    </property>
    <property>
      <name>organization</name>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
    </class>
    <name>GitHubStats.CommittersMacro</name>
    <number>1</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>2f56d0ea-62f3-4b08-b041-f756c19894dc</guid>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>If "true" then also lists contributors who've committed through pull requests</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>contributors</name>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
    </class>
    <name>GitHubStats.CommittersMacro</name>
    <number>2</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>673226b7-99d4-4e25-9d5a-070f5b13f180</guid>
    <property>
      <defaultValue>0</defaultValue>
    </property>
    <property>
      <description>Number of days in the past for which we count commits, by default goes back till the beginning</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>since</name>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
    </class>
    <name>GitHubStats.CommittersMacro</name>
    <number>3</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>7842b658-0855-41f6-a084-d3db87a09ed0</guid>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>Explicit list of repositories to get data for</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>repositories</name>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
    </class>
    <name>GitHubStats.CommittersMacro</name>
    <number>4</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>661fe711-d74c-45b5-b7f5-a10955dfa059</guid>
    <property>
      <defaultValue>false</defaultValue>
    </property>
    <property>
      <description>If "true" then also displays inactive committers, ie committers who've done 0 commits on the period</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>inactives</name>
    </property>
  </object>
  <content/>
</xwikidoc>
